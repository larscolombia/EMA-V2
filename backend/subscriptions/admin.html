<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin Planes</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    table { border-collapse: collapse; width: 100%; margin-top:1rem; }
    th, td { border:1px solid #ccc; padding:6px 8px; font-size:14px; }
    th { background:#f5f5f5; }
    form.inline { display:inline; }
    .badge { padding:2px 6px; border-radius:4px; background:#eee; font-size:12px; }
    .free { background:#c8e6c9; }
    .paid { background:#bbdefb; }
    #msg { margin-top:1rem; font-weight:bold; }
    input[type=text], input[type=number] { width:100%; box-sizing:border-box; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:10px; }
    fieldset { border:1px solid #ddd; padding:10px; }
    legend { font-weight:bold; }
    button { cursor:pointer; }
  </style>
</head>
<body>
  <h1>Planes de Suscripción</h1>
  <p>Interface simple para crear, editar y eliminar planes. Si el precio &gt; 0 se marcará como de pago. Campos Stripe (product/price) se generan/actualizan automáticamente solo si dejas vacíos.</p>
  <div id="msg"></div>
  <section>
    <fieldset>
      <legend>Crear / Actualizar Plan</legend>
      <form id="plan-form">
        <input type="hidden" id="plan-id" />
        <div class="grid">
          <label>Nombre<input id="name" required /></label>
          <label>Moneda<input id="currency" value="USD" required /></label>
          <label>Precio<input id="price" type="number" step="0.01" value="0" required /></label>
          <label>Billing<input id="billing" value="Mensual" required /></label>
          <label>Consultas<input id="consultations" type="number" value="0" required /></label>
          <label>Cuestionarios<input id="questionnaires" type="number" value="0" required /></label>
          <label>Casos clínicos<input id="clinical_cases" type="number" value="0" required /></label>
          <label>Archivos<input id="files" type="number" value="0" required /></label>
          <label>Stripe Product ID (opcional)<input id="stripe_product_id" /></label>
          <label>Stripe Price ID (opcional)<input id="stripe_price_id" /></label>
        </div>
        <p><button type="submit">Guardar</button> <button type="button" id="reset">Limpiar</button></p>
      </form>
    </fieldset>
  </section>
  <section>
    <table id="plans">
      <thead>
        <tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Cuotas</th><th>Stripe</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
<script>
async function fetchJSON(url, opts) { const r = await fetch(url, opts); if(!r.ok) throw new Error(await r.text()); return r.json(); }
const msg = (t,c='')=>{ const el=document.getElementById('msg'); el.textContent=t; el.style.color=c||'black'; };
async function load() {
  const data = await fetchJSON('/plans');
  const tbody = document.querySelector('#plans tbody');
  tbody.innerHTML='';
  data.data.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.id}</td><td>${p.name} <span class="badge ${p.price>0?'paid':'free'}">${p.price>0?'Pago':'Free'}</span></td>`+
      `<td>${p.price} ${p.currency}</td>`+
      `<td>C:${p.consultations} Q:${p.questionnaires} CC:${p.clinical_cases} F:${p.files}</td>`+
      `<td>${p.stripe_product_id||''}<br>${p.stripe_price_id||''}</td>`+
      `<td><button data-edit='${p.id}'>Editar</button> <button data-del='${p.id}'>Eliminar</button></td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById('plans').addEventListener('click', async e=>{
  if(e.target.dataset.edit){
    const id=e.target.dataset.edit; const data=await fetchJSON('/plans'); const plan=data.data.find(x=>x.id==id);
    ['id','name','currency','price','billing','consultations','questionnaires','clinical_cases','files','stripe_product_id','stripe_price_id']
      .forEach(k=>{ const elId = k==='id'?'plan-id':k; const el=document.getElementById(elId); if(el) el.value=plan[k]||''; });
    msg('Editando plan '+plan.name);
  }
  if(e.target.dataset.del){
    if(!confirm('¿Eliminar plan?')) return; const id=e.target.dataset.del;
    await fetch('/plans/'+id,{method:'DELETE'}); msg('Plan eliminado','red'); load();
  }
});
document.getElementById('reset').onclick=()=>{ document.getElementById('plan-form').reset(); document.getElementById('plan-id').value=''; };
document.getElementById('plan-form').onsubmit=async e=>{
  e.preventDefault();
  const p={
    name:name.value.trim(), currency:currency.value.trim(), price:parseFloat(price.value||0), billing:billing.value.trim(),
    consultations:+consultations.value, questionnaires:+questionnaires.value, clinical_cases:+clinical_cases.value, files:+files.value,
    stripe_product_id: stripe_product_id.value.trim()||undefined, stripe_price_id: stripe_price_id.value.trim()||undefined
  };
  const id=document.getElementById('plan-id').value;
  const opts={method: id? 'PUT':'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(p)};
  const url=id? '/plans/'+id : '/plans';
  try{ await fetch(url,opts); msg('Guardado','green'); load(); document.getElementById('plan-form').reset(); document.getElementById('plan-id').value=''; }
  catch(err){ msg('Error: '+err.message,'red'); }
};
load();
</script>
</body>
</html>
